var Q=Object.defineProperty;var j=(r,t,e)=>t in r?Q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var x=(r,t,e)=>j(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const T=1200,C=700,M=0,v=800,E=0,I=800,F=60,z=1.35,b=60,O=4,L=10,J=3.5,tt=25,et=10,it=-30,st=500,ot=200,nt=800,lt=2,ct=.5,ht=100,rt=5e3,at=2e3,dt=-1e4,xt=-25e3,H=160,k=1.2,K=10,ft=[16,18,24],ut=[40,44,58],S=[110,180,255],$=[255,180,110],w=[70,210,120],R=[220,200,80],P=[230,80,90],A=[230,235,245];function gt(r,t,e){return Math.max(t,Math.min(e,r))}function p(r,t,e,n,i){if(i){const o=Math.floor(T/2+r*(k*K/4)),l=Math.floor((t-n)*k+200);return[o,l]}else{const o=Math.floor((r-e)*k+200),l=Math.floor(C/2-t*(k*K/4));return[o,l]}}function c(r){return`rgb(${r[0]}, ${r[1]}, ${r[2]})`}function U(r,t){return`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${t})`}class mt{constructor(t){x(this,"seed");this.seed=t}next(){let t=this.seed+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}uniform(t,e){return this.next()*(e-t)+t}randint(t,e){return Math.floor(this.next()*(e-t+1))+t}}class _{constructor(t){x(this,"seed");x(this,"a1");x(this,"a2");x(this,"w1");x(this,"w2");x(this,"phase1");x(this,"phase2");x(this,"slope");this.seed=t.seed,this.a1=t.a1,this.a2=t.a2,this.w1=t.w1,this.w2=t.w2,this.phase1=t.phase1,this.phase2=t.phase2,this.slope=t.slope}y(t){return t<M+b?this.slope*(t-M)/200:this.slope*(t-M)/200+this.a1*Math.sin(this.w1*(t-b)+this.phase1)+this.a2*Math.sin(this.w2*(t-b)+this.phase2)}x(t){return t<E+b?this.slope*(t-E)/200:this.slope*(t-E)/200+this.a1*Math.sin(this.w1*(t-b)+this.phase1)+this.a2*Math.sin(this.w2*(t-b)+this.phase2)}static random(){const t=Math.floor(Math.random()*1e6),e=new mt(t);return new _({seed:t,a1:e.uniform(8,18),a2:e.uniform(3,10),w1:e.uniform(.01,.018),w2:e.uniform(.02,.035),phase1:e.next()<.5?0:Math.PI,phase2:e.next()<.5?0:Math.PI,slope:e.uniform(-8,8)})}}class N{constructor(t){x(this,"plan");x(this,"x");x(this,"y");x(this,"heading");x(this,"headingTarget");x(this,"score");x(this,"outsideTime");x(this,"finished");x(this,"failed");x(this,"verticalMode");x(this,"actualPoints");x(this,"economics");this.plan=t.plan,this.x=t.x,this.y=t.y,this.heading=t.heading,this.headingTarget=t.headingTarget,this.score=t.score,this.outsideTime=t.outsideTime,this.finished=t.finished,this.failed=t.failed,this.verticalMode=t.verticalMode,this.actualPoints=t.actualPoints,this.economics=t.economics}static createEmptyEconomics(){return{grossRevenue:0,remediationCosts:0,scheduleVariance:0,downstreamPenalty:0,timeInTight:0,timeInOK:0,timeOutside:0,totalTime:0,completionBonus:0}}getAccuracyPercent(){return this.economics.totalTime===0?100:(this.economics.timeInTight+this.economics.timeInOK)/this.economics.totalTime*100}getNetProfit(){return this.economics.grossRevenue-this.economics.remediationCosts-this.economics.downstreamPenalty+this.economics.completionBonus}static new(t=!1){const e=_.random();let n,i,o;return t?(i=E,n=e.x(i),o=0):(n=M,i=e.y(n),o=0),new N({plan:e,x:n,y:i,heading:o,headingTarget:o,score:0,outsideTime:0,finished:!1,failed:!1,verticalMode:t,actualPoints:[[n,i]],economics:N.createEmptyEconomics()})}}class pt{constructor(t){x(this,"canvas");x(this,"ctx");x(this,"drillRigImage",null);x(this,"drillRigLoaded",!1);this.canvas=t,this.canvas.width=T,this.canvas.height=C;const e=t.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e,this.drillRigImage=new Image,this.drillRigImage.onload=()=>{this.drillRigLoaded=!0},this.drillRigImage.src="./drill-rig.png"}clear(){this.ctx.fillStyle=c(ft),this.ctx.fillRect(0,0,T,C)}drawGrid(){this.ctx.strokeStyle=c(ut),this.ctx.lineWidth=1;for(let t=0;t<T;t+=80)this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,C),this.ctx.stroke();for(let t=0;t<C;t+=80)this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(T,t),this.ctx.stroke()}drawCorridor(t,e,n,i,o,l,f){const h=[];if(t.verticalMode){const d=[],s=[],u=[],m=[];for(let g=l;g<=f;g+=4){const y=t.plan.x(g);h.push(p(y,g,e,n,!0)),d.push(p(y-L,g,e,n,!0)),s.push(p(y+L,g,e,n,!0)),u.push(p(y-O,g,e,n,!0)),m.push(p(y+O,g,e,n,!0))}d.length>=2&&this.drawPolygon([...d,...s.reverse()],R,.14),u.length>=2&&this.drawPolygon([...u,...m.reverse()],w,.22)}else{const d=[],s=[],u=[],m=[];for(let g=i;g<=o;g+=4){const y=t.plan.y(g);h.push(p(g,y,e,n,!1)),d.push(p(g,y+L,e,n,!1)),s.push(p(g,y-L,e,n,!1)),u.push(p(g,y+O,e,n,!1)),m.push(p(g,y-O,e,n,!1))}d.length>=2&&this.drawPolygon([...d,...s.reverse()],R,.14),u.length>=2&&this.drawPolygon([...u,...m.reverse()],w,.22)}return{planLine:h}}drawPolygon(t,e,n){if(!(t.length<3)){this.ctx.fillStyle=U(e,n),this.ctx.beginPath(),this.ctx.moveTo(t[0][0],t[0][1]);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i][0],t[i][1]);this.ctx.closePath(),this.ctx.fill()}}drawPlanLine(t){if(!(t.length<2)){this.ctx.strokeStyle=c(S),this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(t[0][0],t[0][1]);for(let e=1;e<t.length;e++)this.ctx.lineTo(t[e][0],t[e][1]);this.ctx.stroke()}}drawPlannedDrillholeLabels(t,e,n,i,o,l,f){const a=t.verticalMode,d=this.drillRigImage?this.drillRigImage.width*.12:0;if(a){if(E>=i-20&&E<=o+20){const s=t.plan.x(E),[u,m]=p(s,E,e,n,!0),g=d+20;this.drawPlanLabel("Planned Collar",u,m,"top",g)}if(I>=i-20&&I<=o+20){const s=t.plan.x(I),[u,m]=p(s,I,e,n,!0);this.drawPlanLabel("Planned Toe",u,m,"bottom",0)}}else{if(M>=l-20&&M<=f+20){const s=t.plan.y(M),[u,m]=p(M,s,e,n,!1),g=d+30;this.drawPlanLabel("Planned Collar",u,m,"left",g)}if(v>=l-20&&v<=f+20){const s=t.plan.y(v),[u,m]=p(v,s,e,n,!1);this.drawPlanLabel("Planned Toe",u,m,"right",0)}}}drawPlanLabel(t,e,n,i,o=0){this.ctx.font='bold 13px Consolas, "Courier New", monospace',this.ctx.textAlign="center",this.ctx.textBaseline="middle";const f=this.ctx.measureText(t).width,a=13,h=6;let d=0,s=0;switch(i){case"top":s=-(30+o);break;case"bottom":s=30+o;break;case"left":d=-(70+o);break;case"right":d=70+o;break}const u=e+d,m=n+s;this.ctx.fillStyle="rgba(0, 20, 30, 0.85)",this.ctx.fillRect(u-f/2-h,m-a/2-h,f+h*2,a+h*2),this.ctx.strokeStyle=c(S),this.ctx.lineWidth=1.5,this.ctx.shadowBlur=4,this.ctx.shadowColor=c(S),this.ctx.strokeRect(u-f/2-h,m-a/2-h,f+h*2,a+h*2),this.ctx.shadowBlur=0,this.ctx.strokeStyle=U(S,.6),this.ctx.lineWidth=1.5,this.ctx.setLineDash([3,3]),this.ctx.beginPath(),this.ctx.moveTo(e,n),this.ctx.lineTo(u,m),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle=c(S),this.ctx.shadowBlur=3,this.ctx.shadowColor=c(S),this.ctx.fillText(t,u,m),this.ctx.shadowBlur=0,this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}drawActualPath(t,e,n,i,o,l,f){const a=[],h=t.actualPoints.slice(-4e3);for(const[d,s]of h)t.verticalMode?s>=l-20&&s<=f+20&&a.push(p(d,s,e,n,!0)):d>=i-20&&d<=o+20&&a.push(p(d,s,e,n,!1));if(a.length>=2){this.ctx.strokeStyle=c($),this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(a[0][0],a[0][1]);for(let d=1;d<a.length;d++)this.ctx.lineTo(a[d][0],a[d][1]);this.ctx.stroke()}}drawDrillRig(t,e,n){if(!this.drillRigLoaded||!this.drillRigImage)return;let i,o;if(t.verticalMode){const h=t.plan.x(E);[i,o]=p(h,E,e,n,!0)}else{const h=t.plan.y(M);[i,o]=p(M,h,e,n,!1)}const l=.12,f=this.drillRigImage.width*l,a=this.drillRigImage.height*l;t.verticalMode?(this.ctx.save(),this.ctx.translate(i,o-a/2),this.ctx.rotate(Math.PI/2),this.ctx.drawImage(this.drillRigImage,-f/2,-a/2,f,a),this.ctx.restore()):this.ctx.drawImage(this.drillRigImage,i-f-10,o-a/2,f,a)}drawDrillHead(t,e,n){const i=p(t.x,t.y,e,n,t.verticalMode);this.ctx.fillStyle=c($),this.ctx.beginPath(),this.ctx.arc(i[0],i[1],7,0,Math.PI*2),this.ctx.fill();let o,l;t.verticalMode?(o=i[0]+Math.floor(24*Math.sin(t.heading)),l=i[1]+Math.floor(24*Math.cos(t.heading))):(o=i[0]+Math.floor(24*Math.cos(t.heading)),l=i[1]-Math.floor(24*Math.sin(t.heading))),this.ctx.strokeStyle=c($),this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(i[0],i[1]),this.ctx.lineTo(o,l),this.ctx.stroke()}formatMoney(t){return(t>=0?"$":"-$")+Math.abs(t).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}drawHUD(t,e){let n,i,o;t.verticalMode?(n="VERTICAL",i=`Depth Y: ${t.y.toFixed(1).padStart(7)} m / ${I.toFixed(0)} m`,o="← → steer | T toggle | R restart"):(n="HORIZONTAL",i=`Depth X: ${t.x.toFixed(1).padStart(7)} m / ${v.toFixed(0)} m`,o="↑ ↓ steer | T toggle | R restart");const l=t.economics,f=t.getNetProfit(),a=t.getAccuracyPercent(),h=[`Mode: ${n}`,i,`Deviation: ${e.toFixed(2).padStart(6)} m`,`Heading: ${(t.heading*180/Math.PI).toFixed(1).padStart(6)}°`,`Outside: ${t.outsideTime.toFixed(1)} / ${J.toFixed(1)} s`,o];this.ctx.fillStyle="rgba(0, 0, 0, 0.55)",this.ctx.fillRect(16,16,320,145),this.ctx.font='16px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(A);let d=34;for(const Z of h)this.ctx.fillText(Z,26,d),d+=20;const s=T-300-16;this.ctx.fillStyle="rgba(0, 0, 0, 0.55)",this.ctx.fillRect(s,16,300,165),this.ctx.font='bold 16px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(S),this.ctx.fillText("FINANCIALS",s+10,34),this.ctx.font='15px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(w),this.ctx.fillText(`Revenue:      ${this.formatMoney(l.grossRevenue).padStart(10)}`,s+10,56),this.ctx.fillStyle=c(P),this.ctx.fillText(`Remediation: ${this.formatMoney(-l.remediationCosts).padStart(10)}`,s+10,76),this.ctx.fillStyle=c(R),this.ctx.fillText(`Sched Delay: ${l.scheduleVariance.toFixed(1).padStart(7)} sec`,s+10,96),this.ctx.fillText(`Downstream:  ${this.formatMoney(-l.downstreamPenalty).padStart(10)}`,s+10,116),this.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",this.ctx.beginPath(),this.ctx.moveTo(s+10,126),this.ctx.lineTo(s+290,126),this.ctx.stroke(),this.ctx.font='bold 16px Consolas, "Courier New", monospace',this.ctx.fillStyle=f>=0?c(w):c(P),this.ctx.fillText(`NET PROFIT:  ${this.formatMoney(f).padStart(10)}`,s+10,146),this.ctx.fillStyle=c(A),this.ctx.font='14px Consolas, "Courier New", monospace',this.ctx.fillText(`Accuracy: ${a.toFixed(0)}%`,s+10,168);const u=s+120,m=160,g=10,y=160;this.ctx.fillStyle="rgba(255, 255, 255, 0.2)",this.ctx.fillRect(u,y,m,g);const B=a/100*m,q=a>=90?w:a>=75||a>=50?R:P;this.ctx.fillStyle=c(q),this.ctx.fillRect(u,y,B,g)}drawBanner(t,e){const n=e<=O?w:e<=L?R:P;let i;t.failed?i="FAILED — too far off plan (press R)":t.finished?i="COMPLETE — nice drilling (press R)":i=e<=L?"ON TRACK":"OFF PLAN",this.ctx.font='bold 28px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(n),this.ctx.fillText(i,16,C-24)}drawEndReport(t){const e=t.economics,n=t.getNetProfit(),i=t.getAccuracyPercent();this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,T,C);const o=500,l=460,f=(T-o)/2,a=(C-l)/2;this.ctx.fillStyle="rgba(20, 24, 32, 0.98)",this.ctx.fillRect(f,a,o,l),this.ctx.strokeStyle=t.failed?c(P):c(w),this.ctx.lineWidth=3,this.ctx.strokeRect(f,a,o,l),this.ctx.font='bold 24px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(A),this.ctx.textAlign="center",this.ctx.fillText("DRILLING OPERATIONS REPORT",T/2,a+40),this.ctx.font='bold 20px Consolas, "Courier New", monospace',t.failed?(this.ctx.fillStyle=c(P),this.ctx.fillText("⚠ HOLE ABANDONED - REDRILL REQUIRED ⚠",T/2,a+70)):(this.ctx.fillStyle=c(w),this.ctx.fillText("✓ DRILLING COMPLETE",T/2,a+70)),this.ctx.textAlign="left";const h=f+30,d=f+280;let s=a+110;this.ctx.font='bold 16px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(S),this.ctx.fillText("PERFORMANCE",h,s),s+=25,this.ctx.font='15px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(A);const u=e.totalTime>0?(e.timeInTight/e.totalTime*100).toFixed(0):"0",m=e.totalTime>0?(e.timeInOK/e.totalTime*100).toFixed(0):"0",g=e.totalTime>0?(e.timeOutside/e.totalTime*100).toFixed(0):"0";this.ctx.fillStyle=c(w),this.ctx.fillText("Time in Tight:",h,s),this.ctx.fillText(`${e.timeInTight.toFixed(1)} sec (${u}%)`,d,s),s+=20,this.ctx.fillStyle=c(R),this.ctx.fillText("Time in OK:",h,s),this.ctx.fillText(`${e.timeInOK.toFixed(1)} sec (${m}%)`,d,s),s+=20,this.ctx.fillStyle=c(P),this.ctx.fillText("Time Outside:",h,s),this.ctx.fillText(`${e.timeOutside.toFixed(1)} sec (${g}%)`,d,s),s+=20,this.ctx.fillStyle=c(A),this.ctx.fillText("Total Time:",h,s),this.ctx.fillText(`${e.totalTime.toFixed(1)} sec`,d,s),s+=20,this.ctx.fillText("Accuracy:",h,s);const y=i>=90?w:i>=75||i>=50?R:P;if(this.ctx.fillStyle=c(y),this.ctx.fillText(`${i.toFixed(1)}%`,d,s),s+=35,this.ctx.font='bold 16px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(S),this.ctx.fillText("FINANCIALS",h,s),s+=25,this.ctx.font='15px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(w),this.ctx.fillText("Gross Revenue:",h,s),this.ctx.fillText(this.formatMoney(e.grossRevenue),d,s),s+=20,this.ctx.fillStyle=c(P),this.ctx.fillText("Remediation Costs:",h,s),this.ctx.fillText(this.formatMoney(-e.remediationCosts),d,s),s+=20,this.ctx.fillStyle=c(R),this.ctx.fillText("Schedule Delay:",h,s),this.ctx.fillText(`${e.scheduleVariance.toFixed(1)} sec`,d,s),s+=20,this.ctx.fillStyle=c(P),this.ctx.fillText("Downstream Penalty:",h,s),this.ctx.fillText(this.formatMoney(-e.downstreamPenalty),d,s),s+=20,e.completionBonus!==0){this.ctx.fillStyle=e.completionBonus>0?c(w):c(P);const B=e.completionBonus>0?"Completion Bonus:":"Completion Penalty:";this.ctx.fillText(B,h,s),this.ctx.fillText(this.formatMoney(e.completionBonus),d,s),s+=20}s+=5,this.ctx.strokeStyle="rgba(255, 255, 255, 0.4)",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(h,s),this.ctx.lineTo(f+o-30,s),this.ctx.stroke(),s+=20,this.ctx.font='bold 18px Consolas, "Courier New", monospace',this.ctx.fillStyle=n>=0?c(w):c(P),this.ctx.fillText("NET PROFIT:",h,s),this.ctx.fillText(this.formatMoney(n),d,s),s+=35,this.ctx.font='16px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(A),this.ctx.textAlign="center",this.ctx.fillText("Press R to restart",T/2,s),this.ctx.textAlign="left"}render(t,e=!1,n=""){this.clear(),this.drawGrid();let i,o,l,f,a,h;t.verticalMode?(o=t.y-40,i=0,a=Math.max(E,o-40),h=Math.min(I,o+H),l=M,f=v):(i=t.x-40,o=0,l=Math.max(M,i-40),f=Math.min(v,i+H),a=E,h=I);const{planLine:d}=this.drawCorridor(t,i,o,l,f,a,h);this.drawPlanLine(d),this.drawPlannedDrillholeLabels(t,i,o,a,h,l,f),this.drawActualPath(t,i,o,l,f,a,h),this.drawDrillRig(t,i,o),this.drawDrillHead(t,i,o);let s;if(t.verticalMode){const u=t.plan.x(t.y);s=Math.abs(t.x-u)}else{const u=t.plan.y(t.x);s=Math.abs(t.y-u)}this.drawHUD(t,s),this.drawBanner(t,s),e&&n?this.drawCountdown(n):(t.finished||t.failed)&&this.drawEndReport(t)}drawCountdown(t){this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,T,C),this.ctx.font='bold 48px Consolas, "Courier New", monospace',this.ctx.fillStyle=c(S),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowBlur=20,this.ctx.shadowColor=c(S),this.ctx.fillText(t,T/2,C/2),this.ctx.shadowBlur=0,this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic"}}class yt{constructor(){x(this,"keysPressed",new Set);x(this,"keysJustPressed",new Set);window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("keyup",this.handleKeyUp.bind(this))}handleKeyDown(t){this.keysPressed.has(t.code)||this.keysJustPressed.add(t.code),this.keysPressed.add(t.code),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","KeyT","KeyR","Escape"].includes(t.code)&&t.preventDefault()}handleKeyUp(t){this.keysPressed.delete(t.code)}isPressed(t){return this.keysPressed.has(t)}wasJustPressed(t){return this.keysJustPressed.has(t)}clearJustPressed(){this.keysJustPressed.clear()}getSteerInput(t){let e=0;return t?(this.isPressed("ArrowLeft")&&(e-=1),this.isPressed("ArrowRight")&&(e+=1)):(this.isPressed("ArrowUp")&&(e+=1),this.isPressed("ArrowDown")&&(e-=1)),e}destroy(){window.removeEventListener("keydown",this.handleKeyDown.bind(this)),window.removeEventListener("keyup",this.handleKeyUp.bind(this))}}class Tt{constructor(t){x(this,"state");x(this,"renderer");x(this,"input");x(this,"lastTime",0);x(this,"running",!1);x(this,"onModeChange");x(this,"countdownActive",!1);x(this,"countdownMessage","");this.renderer=new pt(t),this.input=new yt,this.state=N.new(!1)}start(){this.running=!0,this.lastTime=performance.now(),this.gameLoop()}stop(){this.running=!1}setModeChangeCallback(t){this.onModeChange=t}toggleMode(){var e;if(this.countdownActive)return;const t=!this.state.verticalMode;this.state=N.new(t),(e=this.onModeChange)==null||e.call(this,t)}restart(){this.startCountdown()}async startCountdown(){if(this.countdownActive)return;this.countdownActive=!0;const t=this.state.verticalMode;this.countdownMessage="Moving drill to position...",await this.wait(1e3),this.countdownMessage="Aligning the hole...",await this.wait(1e3),this.countdownMessage="Ready...",await this.wait(1e3),this.countdownMessage="Go!",await this.wait(1e3),this.state=N.new(t),this.countdownActive=!1,this.countdownMessage=""}wait(t){return new Promise(e=>setTimeout(e,t))}isCountdownActive(){return this.countdownActive}getCountdownMessage(){return this.countdownMessage}isVerticalMode(){return this.state.verticalMode}gameLoop(){if(!this.running)return;const t=performance.now(),e=(t-this.lastTime)/1e3;this.lastTime=t,this.handleInput(),this.update(e),this.renderer.render(this.state,this.countdownActive,this.countdownMessage),this.input.clearJustPressed(),requestAnimationFrame(()=>this.gameLoop())}handleInput(){this.input.wasJustPressed("KeyT")&&this.toggleMode(),this.input.wasJustPressed("KeyR")&&this.restart()}update(t){if(this.countdownActive||this.state.finished||this.state.failed)return;const e=this.input.getSteerInput(this.state.verticalMode);this.state.headingTarget+=e*z*t,this.state.headingTarget=gt(this.state.headingTarget,-.55,.55);const n=1-Math.exp(-8*t);if(this.state.heading=(1-n)*this.state.heading+n*this.state.headingTarget,this.state.verticalMode){const l=F*t,f=Math.tan(this.state.heading)*l;this.state.x+=f,this.state.y+=l}else{const l=F*t,f=Math.tan(this.state.heading)*l;this.state.x+=l,this.state.y+=f}this.state.actualPoints.push([this.state.x,this.state.y]);let i;if(this.state.verticalMode){const l=this.state.plan.x(this.state.y);i=Math.abs(this.state.x-l)}else{const l=this.state.plan.y(this.state.x);i=Math.abs(this.state.y-l)}const o=this.state.economics;o.totalTime+=t,i<=O?(this.state.score+=tt*t,o.timeInTight+=t,o.grossRevenue+=st*t,o.scheduleVariance=Math.max(0,o.scheduleVariance-ct*t)):i<=L?(this.state.score+=et*t,o.timeInOK+=t,o.grossRevenue+=ot*t):(this.state.score+=it*t,o.timeOutside+=t,o.remediationCosts+=nt*t,o.scheduleVariance+=lt*t,this.state.outsideTime+=t),o.downstreamPenalty=o.scheduleVariance*ht,i<=L&&(this.state.outsideTime=Math.max(0,this.state.outsideTime-1.8*t)),this.state.outsideTime>=J&&(this.state.failed=!0,this.calculateCompletionBonus()),this.state.verticalMode?this.state.y>=I&&(this.state.finished=!0,this.calculateCompletionBonus()):this.state.x>=v&&(this.state.finished=!0,this.calculateCompletionBonus())}calculateCompletionBonus(){const t=this.state.getAccuracyPercent(),e=this.state.economics;this.state.failed?e.completionBonus=xt:t>=90?e.completionBonus=rt:t>=75?e.completionBonus=at:t<50?e.completionBonus=dt:e.completionBonus=0}}function W(r){const t=document.getElementById("mode-text");t&&(t.textContent=r?"VERTICAL":"HORIZONTAL",t.classList.toggle("vertical",r))}function G(){const r=document.getElementById("help-modal");if(r){r.style.display="flex";const t=r,e=document.getElementById("help-close-x"),n=document.getElementById("help-close-footer");t.addEventListener("click",Y),e==null||e.addEventListener("click",D),n==null||n.addEventListener("click",D),document.addEventListener("keydown",X)}}function D(){const r=document.getElementById("help-modal");if(r){r.style.display="none";const t=r,e=document.getElementById("help-close-x"),n=document.getElementById("help-close-footer");t.removeEventListener("click",Y),e==null||e.removeEventListener("click",D),n==null||n.removeEventListener("click",D),document.removeEventListener("keydown",X)}}function Y(r){const t=r.target;(t.id==="help-modal"||t.classList.contains("modal-overlay"))&&D()}function X(r){r.code==="Escape"&&D()}function V(){const r=document.getElementById("game-canvas"),t=document.getElementById("mode-toggle"),e=document.getElementById("restart-btn"),n=document.getElementById("help-btn");if(!r){console.error("Could not find game canvas element");return}const i=new Tt(r);i.setModeChangeCallback(o=>{W(o)}),t==null||t.addEventListener("click",()=>{i.toggleMode()}),e==null||e.addEventListener("click",()=>{i.restart()}),n==null||n.addEventListener("click",()=>{G()}),window.addEventListener("keydown",o=>{o.code==="KeyH"&&G()}),W(i.isVerticalMode()),i.start(),document.addEventListener("visibilitychange",()=>{})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V();
